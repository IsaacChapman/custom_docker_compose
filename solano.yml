system:
  docker: true

tests:
  - sudo docker-compose --version
  - sudo docker version --format '{{.Server.Version}}'
  - echo $PATH

environment:
  'DOCKER_VERSION': '17.03.2-ce'
  'DOCKER_DEB_URL': 'https://download.docker.com/linux/ubuntu/dists/trusty/pool/stable/amd64/docker-ce_17.03.2~ce-0~ubuntu-trusty_amd64.deb'
  'COMPOSE_VERSION': '1.14.0'

hooks:
  pre_setup: |
    set -o errexit -o pipefail # Exit on error

    # Install Docker if desired version is not already installed
    install_docker() {
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
      sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
      sudo apt-get update -y
      sudo apt-get install -y docker-ce
      mkdir -p $HOME/bin # Early in $PATH
      (cd $HOME/bin && ln -sf /usr/bin/docker docker)
    }
    if ! which docker ; then
      install_docker
    elif dpkg --compare-versions `sudo docker version --format '{{.Server.Version}}'` lt $DOCKER_VERSION ; then
      install_docker
    fi

    # Install Docker Compose if desired version is not already installed
    install_docker_compose() {
      sudo bash -c "curl -L https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose"
      sudo chmod +x /usr/local/bin/docker-compose
      mkdir -p $HOME/bin # Early in $PATH
      (cd $HOME/bin && ln -sf /usr/local/bin/docker-compose docker-compose)
    }
    if ! which docker-compose ; then
      install_docker_compose
    elif dpkg --compare-versions `docker-compose version --short` lt $COMPOSE_VERSION ; then
      install_docker_compose
    fi

tests:
  - sudo docker-compose --version
  - sudo docker version --format '{{.Server.Version}}'
  - echo $PATH